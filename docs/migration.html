<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration Guide - AVP Documentation</title>
    <link rel="icon" href="../assets/avp-icon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .docs-container { max-width: 900px; margin: 0 auto; padding: 2rem; }
        .back-link { display: inline-flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); text-decoration: none; margin-bottom: 2rem; }
        .back-link:hover { color: var(--accent); }
        h1 { color: var(--text-primary); margin-bottom: 0.5rem; }
        h2 { color: var(--accent); margin-top: 2.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
        h3 { color: var(--text-primary); margin-top: 1.5rem; }
        p, li { color: var(--text-secondary); line-height: 1.7; }
        pre { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; overflow-x: auto; margin: 1rem 0; }
        code { font-family: 'Fira Code', 'SF Mono', Monaco, monospace; font-size: 0.9rem; color: var(--accent); }
        pre code { color: var(--text-primary); }
        .step { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; }
        .step h3 { margin-top: 0; color: var(--accent); display: flex; align-items: center; gap: 0.5rem; }
        .step-number { background: var(--accent); color: var(--bg-primary); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; }
        .note { background: rgba(0, 212, 170, 0.1); border-left: 3px solid var(--accent); padding: 1rem; margin: 1rem 0; border-radius: 0 8px 8px 0; }
        .warning { background: rgba(255, 193, 7, 0.1); border-left: 3px solid #ffc107; padding: 1rem; margin: 1rem 0; border-radius: 0 8px 8px 0; }
        .path { display: flex; align-items: center; gap: 1rem; margin: 2rem 0; flex-wrap: wrap; justify-content: center; }
        .path-item { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 1rem 1.5rem; text-align: center; }
        .path-item h4 { color: var(--accent); margin: 0 0 0.5rem 0; }
        .path-item p { margin: 0; font-size: 0.85rem; }
        .path-arrow { color: var(--accent); font-size: 1.5rem; }
    </style>
</head>
<body>
    <div class="docs-container">
        <a href="index.html" class="back-link">← Back to Docs</a>

        <h1>Migration Guide</h1>
        <p>Upgrade your security posture from file to keychain to hardware step-by-step</p>

        <h2>Security Progression Path</h2>
        <div class="path">
            <div class="path-item">
                <h4>File Backend</h4>
                <p>AES-256 encrypted file</p>
            </div>
            <span class="path-arrow">→</span>
            <div class="path-item">
                <h4>Keychain Backend</h4>
                <p>OS-native protection</p>
            </div>
            <span class="path-arrow">→</span>
            <div class="path-item">
                <h4>Hardware Backend</h4>
                <p>FIPS 140-3 HSM</p>
            </div>
        </div>

        <h2>Migrating from .env Files</h2>
        <p>Many projects store credentials in <code>.env</code> files. Here's how to migrate to AVP:</p>

        <div class="step">
            <h3><span class="step-number">1</span> Install AVP CLI</h3>
<pre><code>pip install avp-cli</code></pre>
        </div>

        <div class="step">
            <h3><span class="step-number">2</span> Create a new vault</h3>
<pre><code># Create an encrypted vault file
avp init --backend file --path ~/.avp/vault.enc

# You'll be prompted to create a password
Enter vault password: ********
Confirm password: ********
Vault created successfully!</code></pre>
        </div>

        <div class="step">
            <h3><span class="step-number">3</span> Import from .env</h3>
<pre><code># Import all variables from .env file
avp import .env --format dotenv --workspace my-agent

Imported 5 secrets:
  - OPENAI_API_KEY
  - DATABASE_URL
  - REDIS_URL
  - AWS_ACCESS_KEY_ID
  - AWS_SECRET_ACCESS_KEY</code></pre>
        </div>

        <div class="step">
            <h3><span class="step-number">4</span> Update your code</h3>
            <p>Replace environment variable access with AVP:</p>
<pre><code># Before: Using .env
from dotenv import load_dotenv
import os

load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")

# After: Using AVP
from avp import AVPClient, FileBackend

client = AVPClient(FileBackend("~/.avp/vault.enc", password))
session = client.authenticate("my-agent")
api_key = client.retrieve(session.session_id, "OPENAI_API_KEY").value.decode()</code></pre>
        </div>

        <div class="step">
            <h3><span class="step-number">5</span> Remove .env from version control</h3>
<pre><code># Add to .gitignore
echo ".env" >> .gitignore

# Remove from git history (if previously committed)
git rm --cached .env
git commit -m "Remove .env from version control"</code></pre>
        </div>

        <div class="warning">
            <strong>Security Note:</strong> After migration, securely delete your .env file. Simply deleting it may leave traces on disk. Use secure deletion tools or overwrite the file before deleting.
        </div>

        <h2>File to Keychain Migration</h2>
        <p>Upgrade from file backend to OS-native keychain for better security:</p>

        <div class="step">
            <h3><span class="step-number">1</span> Export from file backend</h3>
<pre><code>avp export --backend file --path ~/.avp/vault.enc \
    --workspace my-agent --output /tmp/secrets.json

# Secrets are temporarily in plaintext - handle carefully!</code></pre>
        </div>

        <div class="step">
            <h3><span class="step-number">2</span> Import to keychain backend</h3>
<pre><code>avp import /tmp/secrets.json --backend keychain \
    --service-name my-app-avp --workspace my-agent

Imported 5 secrets to keychain</code></pre>
        </div>

        <div class="step">
            <h3><span class="step-number">3</span> Securely delete temporary file</h3>
<pre><code># macOS
rm -P /tmp/secrets.json

# Linux
shred -u /tmp/secrets.json

# Windows
cipher /w:C:\temp</code></pre>
        </div>

        <div class="step">
            <h3><span class="step-number">4</span> Update your code</h3>
<pre><code># Before: File backend
from avp import AVPClient, FileBackend

client = AVPClient(FileBackend("~/.avp/vault.enc", password))

# After: Keychain backend
from avp import AVPClient, KeychainBackend

client = AVPClient(KeychainBackend(service_name="my-app-avp"))</code></pre>
        </div>

        <div class="note">
            <strong>Benefit:</strong> With keychain backend, you no longer need to manage a password. The OS protects your credentials using the system keychain, which may be backed by the Secure Enclave or TPM.
        </div>

        <h2>Keychain to Hardware Migration</h2>
        <p>For maximum security, migrate to hardware-backed storage with NexusClaw:</p>

        <div class="step">
            <h3><span class="step-number">1</span> Connect NexusClaw device</h3>
<pre><code># Verify device is connected
avp discover --backend hardware

Device: NexusClaw v1.0
Serial: NC-2024-001234
Firmware: 0.1.0
Secure Element: TROPIC01
Status: Ready</code></pre>
        </div>

        <div class="step">
            <h3><span class="step-number">2</span> Initialize device (first time only)</h3>
<pre><code># Set up device PIN
avp hardware init

Enter new PIN (6-8 digits): ******
Confirm PIN: ******
Device initialized successfully!

# Important: Save your recovery seed phrase
Recovery phrase:
  1. abandon  2. ability  3. able  ...

Store this phrase securely - it cannot be recovered!</code></pre>
        </div>

        <div class="step">
            <h3><span class="step-number">3</span> Export from keychain</h3>
<pre><code>avp export --backend keychain --service-name my-app-avp \
    --workspace my-agent --output /tmp/secrets.json</code></pre>
        </div>

        <div class="step">
            <h3><span class="step-number">4</span> Import to hardware</h3>
<pre><code>avp import /tmp/secrets.json --backend hardware \
    --workspace my-agent

Enter device PIN: ******
Importing secrets to hardware...
  - OPENAI_API_KEY [slot 1]
  - DATABASE_URL [slot 2]
  - AWS_ACCESS_KEY_ID [slot 3]
  ...
Imported 5 secrets to hardware</code></pre>
        </div>

        <div class="step">
            <h3><span class="step-number">5</span> Update your code</h3>
<pre><code># Before: Keychain backend
from avp import AVPClient, KeychainBackend

client = AVPClient(KeychainBackend(service_name="my-app-avp"))

# After: Hardware backend
from avp import AVPClient, HardwareBackend

client = AVPClient(HardwareBackend())  # Auto-detects NexusClaw</code></pre>
        </div>

        <div class="warning">
            <strong>Hardware Limits:</strong> NexusClaw has a limited number of storage slots (typically 32-64). For large numbers of secrets, consider keeping less sensitive ones in keychain and only critical secrets in hardware.
        </div>

        <h2>Multi-Backend Strategy</h2>
        <p>For production systems, consider using multiple backends based on sensitivity:</p>

<pre><code>from avp import AVPClient, FileBackend, KeychainBackend, HardwareBackend

# Tiered security approach
class TieredVault:
    def __init__(self):
        # Critical secrets (API keys, private keys) -> Hardware
        self.hardware = AVPClient(HardwareBackend())

        # Sensitive secrets (database URLs) -> Keychain
        self.keychain = AVPClient(KeychainBackend("my-app"))

        # Development/test secrets -> File
        self.file = AVPClient(FileBackend("./dev-vault.enc", "dev-pass"))

    def get_secret(self, name: str, tier: str = "keychain"):
        if tier == "hardware":
            client = self.hardware
        elif tier == "keychain":
            client = self.keychain
        else:
            client = self.file

        session = client.authenticate("default")
        return client.retrieve(session.session_id, name)

# Usage
vault = TieredVault()
api_key = vault.get_secret("OPENAI_API_KEY", tier="hardware")
db_url = vault.get_secret("DATABASE_URL", tier="keychain")</code></pre>

        <h2>Migration Checklist</h2>
        <ul>
            <li>Backup existing credentials before migration</li>
            <li>Test new backend in staging environment first</li>
            <li>Update all applications using the credentials</li>
            <li>Verify all secrets are accessible after migration</li>
            <li>Securely delete temporary export files</li>
            <li>Remove old backend storage (file, .env) after verification</li>
            <li>Update documentation and runbooks</li>
            <li>Rotate credentials if they may have been exposed during migration</li>
        </ul>

        <footer style="text-align: center; margin-top: 4rem; padding-top: 2rem; border-top: 1px solid var(--border);">
            <p style="color: var(--text-secondary);">
                <a href="https://github.com/avp-protocol/spec" style="color: var(--accent);">Full Specification</a> ·
                <a href="https://github.com/avp-protocol" style="color: var(--accent);">GitHub</a>
            </p>
        </footer>
    </div>
</body>
</html>
